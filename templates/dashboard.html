{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <form method="GET" action="{{ url_for('dashboard') }}" id="year-filter-form" class="d-flex align-items-center">
            <label for="year_filter" class="col-form-label me-2">Year:</label>
            <select class="form-select" id="year_filter" name="year" onchange="document.getElementById('year-filter-form').submit();">
                {% for year in available_years %}
                    <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
                {% if not available_years %}
                    <option>No Data</option>
                {% endif %}
            </select>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card mb-4" id="currentQuarterRevenueCard">
            <div class="card-header">
                <i class="bi bi-pie-chart-fill me-1"></i>
                Current Quarter Revenue by Unit (FY{{ current_fy }} Q{{ current_fq }})
            </div>
            <div class="card-body"><canvas id="currentQuarterRevenueChart" width="100%" height="50"></canvas></div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card mb-4" id="revenueByUnitChartCard">
            <div class="card-header">
                <i class="bi bi-graph-up me-1"></i>
                Quarterly Revenue Projection
            </div>
            <div class="card-body"><canvas id="revenueByUnitChart" width="100%" height="50"></canvas></div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card mb-4" id="revenueByOriginatingTypeChartCard">
            <div class="card-header">
                <i class="bi bi-bar-chart-line me-1"></i>
                Revenue by Originating Type
            </div>
            <div class="card-body"><canvas id="revenueByOriginatingTypeChart" width="100%" height="50"></canvas></div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card mb-4" id="revenueByCSGOwnerChartCard">
            <div class="card-header">
                <i class="bi bi-person-fill me-1"></i>
                Revenue by CSG Owner
            </div>
            <div class="card-body"><canvas id="revenueByCSGOwnerChart" width="100%" height="50"></canvas></div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card mb-4" id="revenueByDeliveryOwnerChartCard">
            <div class="card-header">
                <i class="bi bi-person-workspace me-1"></i>
                Revenue by Delivery Owner
            </div>
            <div class="card-body"><canvas id="revenueByDeliveryOwnerChart" width="100%" height="50"></canvas></div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card mb-4" id="revenueByPortfolioChartCard">
            <div class="card-header">
                <i class="bi bi-briefcase-fill me-1"></i>
                Revenue by Portfolio
            </div>
            <div class="card-body"><canvas id="revenueByPortfolioChart" width="100%" height="50"></canvas></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const selectedYear = document.getElementById('year_filter').value;

    const chartColors = [
        'rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)',
        'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)',
        'rgba(199, 199, 199, 0.6)', 'rgba(83, 102, 255, 0.6)', 'rgba(40, 159, 64, 0.6)'
    ];

    function createChart(chartId, chartType, apiUrl, chartTitle) {
        const ctx = document.getElementById(chartId).getContext('2d');
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response was not ok for ${apiUrl}`);
                }
                return response.json();
            })
            .then(data => {
                data.datasets.forEach((dataset, index) => {
                    // For pie/doughnut charts, we need an array of colors for the data.
                    if (chartType === 'pie' || chartType === 'doughnut') {
                        dataset.backgroundColor = chartColors;
                    } else {
                        dataset.backgroundColor = chartColors[index % chartColors.length];
                    }
                });

                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            // Display legend for multi-dataset charts or for pie charts
                            display: data.datasets.length > 1 || chartType === 'pie' || chartType === 'doughnut'
                        },
                        title: {
                            display: true,
                            text: chartTitle
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';

                                    // For pie charts, the main label for the tooltip is the slice's label
                                    if (context.chart.config.type === 'pie' || context.chart.config.type === 'doughnut') {
                                        label = context.label || '';
                                    }

                                    if (label) {
                                        label += ': ';
                                    }

                                    // Use parsed.y for bar charts, and raw for pie charts.
                                    const value = context.parsed.y ?? context.raw;

                                    // Format the value as currency
                                    if (typeof value === 'number') {
                                        label += new Intl.NumberFormat('en-US', {
                                            style: 'currency',
                                            currency: 'USD'
                                        }).format(value);
                                    }

                                    return label;
                                },
                                footer: function(tooltipItems) {
                                    // Only show a footer for stacked charts where there are multiple items
                                    if (tooltipItems.length <= 1) {
                                        return '';
                                    }
                                    let sum = tooltipItems.reduce((acc, item) => acc + item.parsed.y, 0);
                                    return 'Total: ' + new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(sum);
                                }
                            }
                        }
                    }
                };

                // Add scales only for bar charts, not for pie charts
                if (chartType === 'bar') {
                    chartOptions.interaction = {
                        mode: 'index',
                        intersect: false,
                    };
                    chartOptions.scales = {
                        x: { stacked: true },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return '$' + value.toLocaleString(); }
                            }
                        }
                    };
                }

                new Chart(ctx, {
                    type: chartType,
                    data: data,
                    options: chartOptions
                });
            })
            .catch(error => {
                console.error('Error fetching or creating chart:', chartId, error);
                const cardBody = document.getElementById(chartId).parentElement;
                cardBody.innerHTML = `<p class="text-center text-danger">Could not load chart data.</p>`;
            });
    }
    if (selectedYear && selectedYear !== 'No Data') {
        const yearQuery = `?year=${selectedYear}`;
        createChart('revenueByUnitChart', 'bar', `/api/revenue-by-unit-quarter${yearQuery}`, 'Quarterly Revenue Projection');
        createChart('revenueByOriginatingTypeChart', 'bar', `/api/revenue-by-originating-type${yearQuery}`, 'Revenue by Originating Type');
        createChart('revenueByCSGOwnerChart', 'bar', `/api/revenue-by-csg-owner${yearQuery}`, 'Revenue by CSG Owner');
        createChart('revenueByDeliveryOwnerChart', 'bar', `/api/revenue-by-delivery-owner${yearQuery}`, 'Revenue by Delivery Owner');
        createChart('revenueByPortfolioChart', 'bar', `/api/revenue-by-revenue-portfolio${yearQuery}`, 'Revenue by Portfolio');
    }
    // This chart doesn't depend on the year filter, so it's always created.
    createChart('currentQuarterRevenueChart', 'pie', '/api/revenue-by-unit-current-quarter', 'Current Quarter Revenue by Unit');
});
</script>
{% endblock %}